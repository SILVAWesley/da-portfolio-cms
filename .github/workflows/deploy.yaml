name: Deploy image to AWS EC2

on:
  push:
    branches: ['test/test-workflow']
  pull_request:
    branches: ['test/test-workflow']

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: yarn install --fronzen-lockfile

      - name: Run tests
        run: yarn test

      - name: Build image
        run: docker build . --file Dockerfile --tag wesleyxsilva/da-portfolio-cms:latest

      - name: Login to DockerHub
        run: docker login -u ${{secrets.DOCKER_USERNAME}} -p ${{secrets.DOCKER_TOKEN}}

      - name: Push image
        run: docker push wesleyxsilva/da-portfolio-cms:latest

  deploy:
    needs: build
    runs-on: self-hosted

    steps:
      - name: Pull image
        run: docker pull wesleyxsilva/da-portfolio-cms:latest

      - name: Run container
        run: |
          docker run -d -p 1337:1337 --name da-portfolio-cms \
            -e NODE_ENV=production \
            -e ADMIN_JWT_SECRET=${{secrets.ADMIN_JWT_SECRET}} \
            -e API_TOKEN_SALT=${{secrets.API_TOKEN_SALT}} \
            -e APP_KEYS=${{secrets.APP_KEYS}} \
            -e AWS_ACCESS_KEY_ID=${{secrets.AWS_ACCESS_KEY_ID}} \
            -e AWS_ACCESS_SECRET=${{secrets.AWS_ACCESS_SECRET}} \
            -e AWS_BUCKET_NAME = ${{secrets.AWS_BUCKET_NAME}} \
            -e AWS_REGION = ${{secrets.AWS_REGION}} \
            -e DABASE_CLIENT=${{secrets.DATABASE_CLIENT}} \
            -e DATABASE_URL=${{secrets.DATABASE_URL}} \
            -e DOCKER_TOKEN=${{secrets.DOCKER_TOKEN}} \
            -e DOCKER_USERNAME=${{secrets.DOCKER_USERNAME}} \
            -e HOST=${{secrets.HOST}} \
            -e JWT_SECRET=${{secrets.JWT_SECRET}} \
            -e PORT=${{secrets.PORT}} \
            -e TRANSFER_TOKEN_SALT=${{secrets.TRANSFER_TOKEN_SALT}}
